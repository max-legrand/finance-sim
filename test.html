<!doctype html>
<html>
  <head>
    <title>Finance Sim</title>
    <style>
      .stats {
        margin: 20px 0;
        font-family: monospace;
      }
      #chart {
        width: 100%;
        height: 400px;
        margin: 20px 0;
      }
      .loading {
        color: #666;
        font-style: italic;
      }
      #simulations-container {
        margin-top: 20px;
        font-family: monospace;
      }
      .simulation {
        margin-bottom: 5px;
      }
    </style>
  </head>
  <body>
    <h1>Finance Simulation Stream</h1>
    <div class="stats">
      Simulations received: <span id="count">0</span><br />
      Time elapsed: <span id="elapsed">0</span>s<br />
      Processing rate: <span id="rate">0</span> sims/sec
    </div>
    <div id="chart"></div>
    <pre id="output" class="loading">Waiting for data...</pre>

    <div id="simulations-container"></div>

    <script>
      window.onload = async function () {
        const start = Date.now();
        const output = document.getElementById("output");
        const countEl = document.getElementById("count");
        const elapsedEl = document.getElementById("elapsed");
        const rateEl = document.getElementById("rate");
        const simulationsContainer = document.getElementById(
          "simulations-container",
        );
        let count = 0;
        let buffer = "";
        let statsInterval;

        // Function to update the stats
        function updateStats() {
          const elapsed = (Date.now() - start) / 1000;
          elapsedEl.textContent = elapsed.toFixed(1);
          rateEl.textContent = (count / elapsed).toFixed(1);
          console.log(
            `Elapsed: ${elapsed.toFixed(1)}s, Rate: ${(count / elapsed).toFixed(
              1,
            )} sims/sec, Count: ${count}`,
          ); // Debugging
        }

        try {
          const response = await fetch("http://localhost:3006/sim");

          if (!response.ok) {
            throw new Error(`HTTP error: ${response.status}`);
          }

          if (!response.body) {
            throw new Error("ReadableStream not supported");
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder();

          // Update stats every second
          statsInterval = setInterval(updateStats, 1000);

          // Process the stream
          while (true) {
            const { value, done } = await reader.read();

            if (done) {
              console.log("Stream complete."); // Debugging
              break;
            }

            // Decode the chunk and add it to our buffer
            buffer += decoder.decode(value, { stream: true });
            console.log(buffer);

            // Process complete lines in the buffer
            let newlineIndex;
            while ((newlineIndex = buffer.indexOf("\n")) !== -1) {
              const line = buffer.slice(0, newlineIndex);
              console.log(line);
              buffer = buffer.slice(newlineIndex + 1);

              if (line.trim()) {
                try {
                  // Safely parse the line as a JavaScript array
                  const simulation = new Function(`return ${line}`)();

                  count++;
                  countEl.textContent = count;

                  // Create a new div for the simulation
                  const simulationDiv = document.createElement("div");
                  simulationDiv.classList.add("simulation");
                  simulationDiv.textContent = JSON.stringify(simulation);

                  // Append the simulation div to the container
                  simulationsContainer.appendChild(simulationDiv);

                  // Keep only the last line in the output for performance
                  output.textContent = `Latest simulation: ${JSON.stringify(
                    simulation,
                  ).slice(0, 100)}...`;

                  // Update stats immediately after processing a simulation
                  updateStats(); // <---- THIS IS THE KEY CHANGE
                } catch (e) {
                  console.error("Error parsing JavaScript array:", e);
                }
              }
            }
          }
        } catch (error) {
          output.textContent = `Error: ${error.message}`;
          output.style.color = "red";
          console.error("Error:", error);
        } finally {
          clearInterval(statsInterval);
          const elapsed = (Date.now() - start) / 1000;
          output.textContent = `Completed: ${count} simulations in ${elapsed.toFixed(
            1,
          )}s`;
          output.classList.remove("loading");
        }
      };
    </script>
  </body>
</html>
